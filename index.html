<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quotation</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body {
    font-family:'Poppins',sans-serif;
    background:#eef3f9;
    padding:8px;
    font-size:13px;
}

/* FORCE COLORS IN PRINT */
* {
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
}

.quotation-box {
  max-width:900px; margin:auto; background:white; padding:12px 10px;
  box-shadow:0 5px 12px rgba(0,0,0,0.06);
}

/* ðŸ”¥ HEADER FIX */
.header {
  position:relative;
  min-height:80px;
}

.logo-area img { height:60px; margin-bottom:5px; }

.logo-area p {
  font-size:13px;
  line-height:1.4;
  margin:0;
}

/* TITLE LOCKED TOP RIGHT */
.quote-title {
  position:absolute;
  top:0;
  right:0;
  font-size:32px;
  font-weight:700;
  color:#0b3d91;
}

.wave { height:8px; background:linear-gradient(90deg,#0b3d91,#2a7fff);
  margin:15px 0 20px; border-radius:4px; }

.info-grid { display:flex; justify-content:space-between; flex-wrap:wrap; gap:20px; }
.info-grid div { flex:1; min-width:250px; }

.client-details {
  background:#f9faff;
  padding:5px 6px;
  border-left:3px solid #0b3d91;
  margin:6px 0;
  border-radius:3px;
  font-size:12px;
}

.client-details input, .client-details textarea {
    font-size:12px;
    padding:1px 1px;
    margin-bottom:1px;
}

input, textarea {
  border:none;
  border-bottom:1px solid #aaa;
  font-family:inherit;
  width:100%;
  background:transparent;
  font-size:12px;
  padding:1.5px 1px;
}

textarea {
    resize:none; overflow:hidden; min-height:28px;
}

.section-title {
  background:linear-gradient(90deg,#0b3d91,#2a7fff);
  color:white; padding:4px 8px; font-weight:600; margin-top:14px; font-size:14px;
}

table { width:100%; border-collapse:collapse; margin-top:6px; font-size:12px; }
th {
  background:linear-gradient(90deg,#0b3d91,#2a7fff);
  color:white; padding:4px;
}
td { border:1px solid #ddd; padding:3px; vertical-align:top; }

/* TOTALS BOX */
.totals-box {
  margin-top:10px;
  margin-left:auto;
  width:260px;
  border:1px solid #0b3d91;
  padding:6px 8px;
  border-radius:3px;
  background:#f7faff;
}

.totals-row {
  display:flex;
  justify-content:space-between;
  margin:3px 0;
  font-size:13px;
}

.grand {
  font-size:14px;
  font-weight:700;
  color:#0b3d91;
  border-top:1px solid #0b3d91;
  padding-top:3px;
}

.two-columns { display:flex; justify-content:space-between; flex-wrap:wrap; gap:8px; margin-top:10px; }
.two-columns div { flex:1; min-width:180px; }

.footer { text-align:center; margin-top:12px; color:#0b3d91; font-weight:500; font-size:13px; }

.buttons { text-align:center; margin-top:15px; }
button {
  padding:8px 14px; margin:4px; border:none; border-radius:5px;
  background:#0b3d91; color:white; cursor:pointer;
}

.client-field-row {
  display:flex;
  align-items:center;
  gap:2px;
  margin-bottom:2px;
}

.client-label {
  width:160px;
  min-width:120px;
  font-weight:500;
}
.client-value {
  flex:1;
}
.remove-client-field {
  background:#e74c3c;
  color:white;
  border:none;
  border-radius:3px;
  padding:2px 8px;
  font-size:16px;
  cursor:pointer;
}
.remove-client-field:hover {
  background:#c0392b;
}
.add-client-field-btn {
  /* for targeting the add field button */
}
@media print {
  .page, .quotation-content, .quotation-box, .client-details, .totals-box, .two-columns, .footer, tr, td, th {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }
  .page {
    page-break-after: always;
    break-after: page;
  }
  body { background:white; }
  .buttons,
  .remove-client-field,
  .add-client-field-btn {
    display:none !important;
  }
  table {
    page-break-inside:auto;
  }
  textarea {
    height:auto !important;
    min-height:0 !important;
    max-height:none !important;
    overflow:visible !important;
    white-space:pre-wrap !important;
    word-wrap:break-word !important;
    border:none !important;
    padding:0 !important;
    line-height:1.4 !important;
  }
  input {
    border:none !important;
  }
  table, th, td {
    border:1px solid #000 !important;
  }
}
</style>
</head>

<body>
<div id="pdf-export">
<div class="quotation-box">

  <div class="header">
    <div class="logo-area">
      <img src="aa.jpeg">
      <p>
        BKM complex <br>
        Kozhikode Road <br>
        Perinthalmanna <br>
        Malappuram <br>
        Kerala-679322 <br>
        Contact: +91 99957 15997
      </p>
    </div>

    <div class="quote-title">QUOTATION</div>
  </div>

  <div class="wave"></div>

  <div class="info-grid">
    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.5em;">
      <p style="margin-bottom: 0.2em;">Quotation No: <input></p>
      <div style="display: flex; align-items: center; gap: 0.5em; margin-left: 2px;">
        <label for="dateDisplay" style="font-weight:500; margin-bottom:0;">Date:</label>
        <input type="text" id="dateDisplay" style="width:120px;cursor:pointer;background:#f9faff;" placeholder="DD/MM/YYYY"> 
        <input type="date" id="dateInput" style="width:0;height:0;border:none;padding:0;margin:0;opacity:0;position:absolute;pointer-events:none;" tabindex="-1">
      </div>
    </div>
  </div>

  <!-- DYNAMIC CLIENT DETAILS SECTION -->
  <div class="section-title">Client Details</div>
  <div class="client-details">
        <div class="two-columns">
          <div>
            <div class="client-field-row">
              <input class="client-label" placeholder="Label (e.g. Client Name)" value="Client Name">:
              <input class="client-value" placeholder="Value (e.g. John Doe)">
              <button type="button" class="remove-client-field" onclick="removeClientField(this)">-</button>
            </div>
            <div class="client-field-row">
              <input class="client-label" placeholder="Label (e.g. Business Name)" value="Business Name">:
              <input class="client-value" placeholder="Value (e.g. Acme Corp)">
              <button type="button" class="remove-client-field" onclick="removeClientField(this)">-</button>
            </div>
            <div class="client-field-row">
              <input class="client-label" placeholder="Label (e.g. Address)" value="Address">:
              <textarea class="client-value" placeholder="Value (e.g. Street, City, State)"></textarea>
              <button type="button" class="remove-client-field" onclick="removeClientField(this)">-</button>
            </div>
          </div>
          <div>
            <div class="client-field-row">
              <input class="client-label" placeholder="Label (e.g. Contact No)" value="Contact No">:
              <input class="client-value" placeholder="Value (e.g. 9876543210)">
              <button type="button" class="remove-client-field" onclick="removeClientField(this)">-</button>
            </div>
            <div class="client-field-row">
              <input class="client-label" placeholder="Label (e.g. Email)" value="Email">:
              <input class="client-value" placeholder="Value (e.g. mail@example.com)">
              <button type="button" class="remove-client-field" onclick="removeClientField(this)">-</button>
            </div>
            <div class="client-field-row">
              <input class="client-label" placeholder="Label (e.g. GST No)" value="GST No">:
              <input class="client-value" placeholder="Value (e.g. 22AAAAA0000A1Z5)">
              <button type="button" class="remove-client-field" onclick="removeClientField(this)">-</button>
            </div>
          </div>
        </div>
        <div style="margin-top:10px; text-align:right;">
          <button type="button" class="add-client-field-btn" onclick="addClientField()">Add Field</button>
        </div>
      </div>

  <div class="section-title">Project Overview</div>
  <textarea oninput="autoGrow(this)" style="min-height:28px;overflow:hidden;width:100%"></textarea>

  <div class="section-title">Services & Pricing</div>
  <table id="serviceTable">
    <tr>
      <th style="width:50px;">No</th>
      <th>Service</th>
      <th>Description</th>
      <th style="width:120px;">Amount (â‚¹)</th>
    </tr>
    <tr>
      <td>1</td>
      <td><textarea oninput="autoGrow(this)" style="min-height:40px;overflow:hidden;"></textarea></td>
      <td><textarea oninput="autoGrow(this)" style="min-height:40px;overflow:hidden;"></textarea></td>
      <td><input type="number" value="0" oninput="calculateTotal()"></td>
    </tr>
  </table>

  <div class="buttons">
    <button onclick="addRow()">Add Row</button>
    <button onclick="removeRow()">Remove Row</button>
  </div>

  <div class="totals-box">
    <div class="totals-row">
      <span>Total Amount</span>
      <span>â‚¹ <span id="subtotal">0.00</span></span>
    </div>
    <div class="totals-row grand">
      <span>Grand Total</span>
      <span>â‚¹ <span id="grandTotal">0.00</span></span>
    </div>
  </div>

  <div class="two-columns">
    <div>
      <div class="section-title">Payment Terms</div>
      <ul>
        <li>50% advance before start</li>
        <li>50% after 2 weeks</li>
      </ul>
    </div>
    <div>
      <div class="section-title">Terms & Conditions</div>
      <ul>
        <li>Additional work outside scope is chargeable</li>
        <li>Revisions limited as per plan</li>
        <li>Advance payment non-refundable</li>
      </ul>
    </div>
  </div>

  <div class="footer">Thank you for choosing FyntricTech IT Solutions</div>
</div>

</div>
<div class="buttons">
  <button onclick="window.print()">Print</button>
</div>

<script>
function autoGrow(el){
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight) + 'px';
}

// Apply autoGrow to all textareas on page load
window.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('textarea').forEach(function(el) {
    autoGrow(el);
    el.addEventListener('input', function() { autoGrow(el); });
  });
  // Apply autoGrow to Project Overview textarea on page load
  var overview = document.querySelector('.section-title + textarea');
  if (overview) {
    autoGrow(overview);
    overview.addEventListener('input', function() { autoGrow(overview); });
  }
});

function updateNumbers(){
  const rows=document.querySelectorAll("#serviceTable tr");
  rows.forEach((row,i)=>{ if(i>0) row.cells[0].innerText=i; });
}

function addRow(){
  const table=document.getElementById("serviceTable");
  const row=table.insertRow();
  row.className = 'service-row';
  row.innerHTML=`<td></td>
  <td><textarea oninput=\"autoGrow(this)\" style=\"min-height:40px;overflow:hidden;width:100%\"></textarea></td>
  <td><textarea oninput=\"autoGrow(this)\" style=\"min-height:40px;overflow:hidden;width:100%\"></textarea></td>
  <td><input type=\"number\" value=\"0\" oninput=\"calculateTotal()\"></td>`;
  updateNumbers();
  // Ensure new textareas auto-expand
  row.querySelectorAll('textarea').forEach(function(el) {
    autoGrow(el);
    el.addEventListener('input', function() { autoGrow(el); });
  });
}

function removeRow(){
  const table=document.getElementById("serviceTable");
  if(table.rows.length>2){
    table.deleteRow(-1);
    updateNumbers();
    calculateTotal();
  }
}

function calculateTotal(){
  const inputs=document.querySelectorAll("#serviceTable input[type='number']");
  let subtotal=0;
  inputs.forEach(i=>subtotal+=Number(i.value));
  document.getElementById("subtotal").innerText=subtotal.toFixed(2);
  document.getElementById("grandTotal").innerText=subtotal.toFixed(2);
}

function addClientField() {
  const row = document.createElement('div');
  row.className = 'client-field-row';
  row.innerHTML = `
    <input class="client-label" placeholder="Label (e.g. Custom Field)">:
    <input class="client-value" placeholder="Value">
    <button type="button" class="remove-client-field" onclick="removeClientField(this)">-</button>
  `;
  document.getElementById('clientFields').appendChild(row);
}

function removeClientField(btn) {
  const row = btn.parentElement;
  if(document.querySelectorAll('#clientFields .client-field-row').length > 1) {
    row.remove();
  }
}

// Date formatting for display (DD/MM/YYYY in input, sync both ways)
const dateInput = document.getElementById('dateInput');
const dateDisplay = document.getElementById('dateDisplay');
if(dateInput && dateDisplay) {
  // Show calendar on click of dateDisplay
  dateDisplay.onclick = function() { dateInput.click(); };
  // When picking from calendar, update text input
  dateInput.addEventListener('input', function() {
    if(this.value) {
      const [yyyy, mm, dd] = this.value.split('-');
      dateDisplay.value = dd + '/' + mm + '/' + yyyy;
    } else {
      dateDisplay.value = '';
    }
  });
  // When typing in text input, update hidden date input
  dateDisplay.addEventListener('input', function() {
    const match = this.value.match(/^([0-3][0-9])\/(0[1-9]|1[0-2])\/(\d{4})$/);
    if(match) {
      const [_, dd, mm, yyyy] = match;
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    } else {
      dateInput.value = '';
    }
  });
}

// Remove any lingering .print-replaced divs on input, click, and after print to prevent duplicate content
function cleanPrintDivs() {
  document.querySelectorAll('.print-replaced').forEach(function(div) {
    const textarea = div.previousElementSibling;
    if (textarea && textarea.tagName === 'TEXTAREA') {
      textarea.style.display = '';
    }
    div.remove();
  });
}
document.addEventListener('input', cleanPrintDivs);
document.addEventListener('click', cleanPrintDivs);
window.onafterprint = function() {
  cleanPrintDivs();
};

// Ensure preparePrintTextareas never creates more than one print-replaced div per textarea
function preparePrintTextareas() {
  document.querySelectorAll('#serviceTable textarea, .section-title + textarea').forEach(function(textarea) {
    // Remove any existing print-replaced div before creating a new one
    if (textarea.nextElementSibling && textarea.nextElementSibling.classList && textarea.nextElementSibling.classList.contains('print-replaced')) {
      textarea.nextElementSibling.remove();
    }
    if (!textarea.classList.contains('print-replaced')) {
      const div = document.createElement('div');
      div.textContent = textarea.value;
      div.style.whiteSpace = 'pre-wrap';
      div.style.wordBreak = 'break-word';
      div.style.minHeight = '28px';
      div.style.fontFamily = 'inherit';
      div.style.fontSize = '12px';
      div.style.padding = '1.5px 1px';
      div.style.background = 'none';
      div.style.border = 'none';
      div.className = 'print-replaced';
      div.style.display = 'block';
      textarea.style.display = 'none';
      textarea.parentNode.insertBefore(div, textarea.nextSibling);
    }
  });
}

function restoreTextareasAfterPrint() {
  document.querySelectorAll('.print-replaced').forEach(function(div) {
    const textarea = div.previousElementSibling;
    if (textarea && textarea.tagName === 'TEXTAREA') {
      textarea.style.display = '';
    }
    div.remove();
  });
}
if (window.matchMedia) {
  window.matchMedia('print').addEventListener('change', function(e) {
    if (e.matches) {
      preparePrintTextareas();
    } else {
      restoreTextareasAfterPrint();
    }
  });
}
window.onbeforeprint = preparePrintTextareas;
window.onafterprint = restoreTextareasAfterPrint;

// Improved checkOverflow: move whole sections to new pages if they overflow
function checkOverflow() {
  const pages = document.querySelectorAll('.page');
  const lastPage = pages[pages.length - 1];
  const content = lastPage.querySelector('.quotation-content');
  if (content.scrollHeight > lastPage.clientHeight - 40) {
    // Find the last major section in .quotation-content
    const sections = Array.from(content.children);
    let moveIndex = sections.length - 1;
    let totalHeight = 0;
    for (let i = 0; i < sections.length; i++) {
      totalHeight += sections[i].offsetHeight;
      if (totalHeight > lastPage.clientHeight - 40) {
        moveIndex = i;
        break;
      }
    }
    // Move overflowing sections to a new page
    const newPage = document.createElement('div');
    newPage.className = 'page';
    const newContent = document.createElement('div');
    newContent.className = 'quotation-content';
    for (let i = moveIndex; i < sections.length; i++) {
      newContent.appendChild(sections[i]);
    }
    newPage.appendChild(newContent);
    document.body.appendChild(newPage);
  }
}
</script>
</body>
</html>
